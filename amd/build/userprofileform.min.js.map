{"version":3,"file":"userprofileform.min.js","sources":["../src/userprofileform.js"],"sourcesContent":["/**\n * Add the form to the page\n *\n * @module      filter_envf/userprofileform.js\n * @copyright   CALL Learning - Laurent David <laurent@call-learning.fr>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_string as getString} from 'core/str';\nimport Fragment from 'core/fragment';\nimport Templates from 'core/templates';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\nconst validUserFields = [\n    'id',\n    'username',\n    'auth',\n    'suspended',\n    'firstname',\n    'lastname',\n    'email',\n    'maildisplay',\n    'city',\n    'country',\n    'timezone',\n    'description',\n    'userpicture',\n    'firstnamephonetic',\n    'lastnamephonetic',\n    'middlename',\n    'alternatename',\n    'interests',\n    'url',\n    'icq',\n    'skype',\n    'aim',\n    'yahoo',\n    'msn',\n    'idnumber',\n    'institution',\n    'department',\n    'phone1',\n    'phone2',\n    'address',\n    'lang',\n    'calendartype',\n    'theme',\n    'mailformat',\n    'customfields',\n    'preferences',\n];\n\nclass UserForm {\n    constructor(formelement, contextid, userid) {\n        this.formelementcontainer = formelement;\n        this.contextid = contextid;\n        this.userid = userid;\n        formelement.addEventListener('submit', this.submitFormAjax.bind(this));\n    }\n\n    submitFormAjax(e) {\n        // We don't want to do a real form submission.\n        e.preventDefault();\n\n        let changeEvent = document.createEvent('HTMLEvents');\n        changeEvent.initEvent('change', true, true);\n\n        // Prompt all inputs to run their validation functions.\n        // Normally this would happen when the form is submitted, but\n        // since we aren't submitting the form normally we need to run client side\n        // validation.\n        let formelement = this.formelementcontainer.querySelector('form');\n        formelement.querySelectorAll('input, textarea, select, button')\n            .forEach(element => {\n                element.dispatchEvent(changeEvent);\n                }\n            );\n\n        // Now the change events have run, see if there are any \"invalid\" form fields.\n        const invalidElementsAria = [...formelement.querySelectorAll('[aria-invalid=\"true\"]')];\n        const invalidElementsError = [...formelement.querySelectorAll('.error')];\n        const invalid = [...invalidElementsAria, ...invalidElementsError];\n\n        // If we found invalid fields, focus on the first one and do not submit via ajax.\n        if (invalid.length) {\n            invalid.first().focus();\n            return;\n        }\n        let formelementcontainer = this.formelementcontainer;\n        const formDataObj = new FormData(formelement);\n        let formDataAsObject = {};\n        for (let [key, value] of formDataObj.entries()) {\n            formDataAsObject[key] = value;\n        }\n        let formData = JSON.stringify(formDataAsObject);\n        let params = {\n            'jsonformdata': formData\n        };\n        let userform = this;\n        // Reload the form to check for errors.\n        Fragment.loadFragment('filter_envf',\n            'userprofile_form',\n            this.contextid,\n            params)\n            .then((form, js) => {\n                Templates.replaceNodeContents(formelementcontainer, form, js);\n                const childElement = formelementcontainer.querySelector('.upf-userformvalidated');\n                let validatedData = childElement ? childElement.dataset.validated : false;\n                if (validatedData) {\n                    const formData = new FormData(formelementcontainer.querySelector('form'));\n                    let formDataCombined = {};\n\n                    for (let [key, value] of formData.entries()) {\n                        if (validUserFields.includes(key)) {\n                            formDataCombined[key] = value;\n                        }\n                    }\n                    if (typeof formDataCombined.newpassword !== undefined) {\n                        delete formDataCombined.newpassword;\n                    }\n                    if (typeof formDataCombined.password !== undefined) {\n                        delete formDataCombined.password;\n                    }\n                    // Now we can continue and send the data...\n                    Ajax.call([{\n                        methodname: 'filter_envf_update_user',\n                        args: {userdata: formDataCombined},\n                        done: userform.handleFormSubmissionResponse.bind(userform, formDataCombined),\n                        fail: userform.handleFormSubmissionFailure.bind(userform, formDataCombined)\n                    }]);\n                }\n                return validatedData;\n            }).catch(Notification.exception);\n    }\n\n    handleFormSubmissionResponse(data) {\n        getString('userupdated', 'filter_envf', data).done(\n            (str) => {\n                Notification.addNotification({\n                    message: str,\n                    type: \"info\"\n                });\n            }\n        );\n    }\n\n    handleFormSubmissionFailure(data) {\n        getString('userupdated', 'filter_envf', data).done(\n            (str) => {\n                Notification.addNotification({\n                    message: str,\n                    type: \"warning\"\n                });\n            }\n        );\n    }\n}\n\nexport const init = (args) => {\n    const elements = document.querySelectorAll('.' + args.classmarker);\n\n    elements.forEach(element => {\n        const userid = element.dataset.userid;\n        const contextid = element.dataset.contextid;\n        const params = {};\n\n        Fragment.loadFragment('filter_envf', 'userprofile_form', contextid, params)\n            .then((form, js) => {\n                Templates.replaceNodeContents(element, form, js);\n                new UserForm(element, contextid, userid); // Bind the form.\n                return true;\n            })\n            .catch(Notification.exception);\n    });\n};"],"names":["validUserFields","UserForm","constructor","formelement","contextid","userid","formelementcontainer","addEventListener","this","submitFormAjax","bind","e","preventDefault","changeEvent","document","createEvent","initEvent","querySelector","querySelectorAll","forEach","element","dispatchEvent","invalid","length","first","focus","formDataObj","FormData","formDataAsObject","key","value","entries","params","JSON","stringify","userform","loadFragment","then","form","js","replaceNodeContents","childElement","validatedData","dataset","validated","formData","formDataCombined","includes","undefined","newpassword","password","call","methodname","args","userdata","done","handleFormSubmissionResponse","fail","handleFormSubmissionFailure","catch","Notification","exception","data","str","addNotification","message","type","classmarker"],"mappings":";;;;;;;0QAcMA,gBAAkB,CACpB,KACA,WACA,OACA,YACA,YACA,WACA,QACA,cACA,OACA,UACA,WACA,cACA,cACA,oBACA,mBACA,aACA,gBACA,YACA,MACA,MACA,QACA,MACA,QACA,MACA,WACA,cACA,aACA,SACA,SACA,UACA,OACA,eACA,QACA,aACA,eACA,qBAGEC,SACFC,YAAYC,YAAaC,UAAWC,aAC3BC,qBAAuBH,iBACvBC,UAAYA,eACZC,OAASA,OACdF,YAAYI,iBAAiB,SAAUC,KAAKC,eAAeC,KAAKF,OAGpEC,eAAeE,GAEXA,EAAEC,qBAEEC,YAAcC,SAASC,YAAY,cACvCF,YAAYG,UAAU,UAAU,GAAM,OAMlCb,YAAcK,KAAKF,qBAAqBW,cAAc,QAC1Dd,YAAYe,iBAAiB,mCACxBC,SAAQC,UACLA,QAAQC,cAAcR,sBAOxBS,QAAU,IAFY,IAAInB,YAAYe,iBAAiB,6BAChC,IAAIf,YAAYe,iBAAiB,eAI1DI,QAAQC,mBACRD,QAAQE,QAAQC,YAGhBnB,qBAAuBE,KAAKF,2BAC1BoB,YAAc,IAAIC,SAASxB,iBAC7ByB,iBAAmB,OAClB,IAAKC,IAAKC,SAAUJ,YAAYK,UACjCH,iBAAiBC,KAAOC,UAGxBE,OAAS,cADEC,KAAKC,UAAUN,mBAI1BO,SAAW3B,uBAEN4B,aAAa,cAClB,mBACA5B,KAAKJ,UACL4B,QACCK,MAAK,CAACC,KAAMC,yBACCC,oBAAoBlC,qBAAsBgC,KAAMC,UACpDE,aAAenC,qBAAqBW,cAAc,8BACpDyB,gBAAgBD,cAAeA,aAAaE,QAAQC,aACpDF,cAAe,OACTG,SAAW,IAAIlB,SAASrB,qBAAqBW,cAAc,aAC7D6B,iBAAmB,OAElB,IAAKjB,IAAKC,SAAUe,SAASd,UAC1B/B,gBAAgB+C,SAASlB,OACzBiB,iBAAiBjB,KAAOC,YAGYkB,WAAjCF,iBAAiBG,oBACjBH,iBAAiBG,iBAEaD,WAA9BF,iBAAiBI,iBACjBJ,iBAAiBI,uBAGvBC,KAAK,CAAC,CACPC,WAAY,0BACZC,KAAM,CAACC,SAAUR,kBACjBS,KAAMpB,SAASqB,6BAA6B9C,KAAKyB,SAAUW,kBAC3DW,KAAMtB,SAASuB,4BAA4BhD,KAAKyB,SAAUW,4BAG3DJ,iBACRiB,MAAMC,sBAAaC,WAG9BL,6BAA6BM,0BACf,cAAe,cAAeA,MAAMP,MACzCQ,4BACgBC,gBAAgB,CACzBC,QAASF,IACTG,KAAM,YAMtBR,4BAA4BI,0BACd,cAAe,cAAeA,MAAMP,MACzCQ,4BACgBC,gBAAgB,CACzBC,QAASF,IACTG,KAAM,8BAOLb,OACAvC,SAASI,iBAAiB,IAAMmC,KAAKc,aAE7ChD,SAAQC,gBACPf,OAASe,QAAQuB,QAAQtC,OACzBD,UAAYgB,QAAQuB,QAAQvC,4BAGzBgC,aAAa,cAAe,mBAAoBhC,UAF1C,IAGViC,MAAK,CAACC,KAAMC,yBACCC,oBAAoBpB,QAASkB,KAAMC,QACzCtC,SAASmB,QAAShB,UAAWC,SAC1B,KAEVsD,MAAMC,sBAAaC"}