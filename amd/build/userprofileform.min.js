define("filter_envf/userprofileform",["exports","core/str","core/fragment","core/templates","core/ajax","core/notification"],(function(_exports,_str,_fragment,_templates,_ajax,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Add the form to the page
   *
   * @module      filter_envf/userprofileform.js
   * @copyright   CALL Learning - Laurent David <laurent@call-learning.fr>
   * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_fragment=_interopRequireDefault(_fragment),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);const validUserFields=["id","username","auth","suspended","firstname","lastname","email","maildisplay","city","country","timezone","description","userpicture","firstnamephonetic","lastnamephonetic","middlename","alternatename","interests","url","icq","skype","aim","yahoo","msn","idnumber","institution","department","phone1","phone2","address","lang","calendartype","theme","mailformat","customfields","preferences"];class UserForm{constructor(formelement,contextid,userid){this.formelementcontainer=formelement,this.contextid=contextid,this.userid=userid,formelement.addEventListener("submit",this.submitFormAjax.bind(this))}submitFormAjax(e){e.preventDefault();let changeEvent=document.createEvent("HTMLEvents");changeEvent.initEvent("change",!0,!0);let formelement=this.formelementcontainer.querySelector("form");formelement.querySelectorAll("input, textarea, select, button").forEach((element=>{element.dispatchEvent(changeEvent)}));const invalid=[...[...formelement.querySelectorAll('[aria-invalid="true"]')],...[...formelement.querySelectorAll(".error")]];if(invalid.length)return void invalid.first().focus();let formelementcontainer=this.formelementcontainer;const formDataObj=new FormData(formelement);let formDataAsObject={};for(let[key,value]of formDataObj.entries())formDataAsObject[key]=value;let params={jsonformdata:JSON.stringify(formDataAsObject)},userform=this;_fragment.default.loadFragment("filter_envf","userprofile_form",this.contextid,params).then(((form,js)=>{_templates.default.replaceNodeContents(formelementcontainer,form,js);const childElement=formelementcontainer.querySelector(".upf-userformvalidated");let validatedData=!!childElement&&childElement.dataset.validated;if(validatedData){const formData=new FormData(formelementcontainer.querySelector("form"));let formDataCombined={};for(let[key,value]of formData.entries())validUserFields.includes(key)&&(formDataCombined[key]=value);void 0!==typeof formDataCombined.newpassword&&delete formDataCombined.newpassword,void 0!==typeof formDataCombined.password&&delete formDataCombined.password,_ajax.default.call([{methodname:"filter_envf_update_user",args:{userdata:formDataCombined},done:userform.handleFormSubmissionResponse.bind(userform,formDataCombined),fail:userform.handleFormSubmissionFailure.bind(userform,formDataCombined)}])}return validatedData})).catch(_notification.default.exception)}handleFormSubmissionResponse(data){(0,_str.get_string)("userupdated","filter_envf",data).done((str=>{_notification.default.addNotification({message:str,type:"info"})}))}handleFormSubmissionFailure(data){(0,_str.get_string)("userupdated","filter_envf",data).done((str=>{_notification.default.addNotification({message:str,type:"warning"})}))}}_exports.init=args=>{document.querySelectorAll("."+args.classmarker).forEach((element=>{const userid=element.dataset.userid,contextid=element.dataset.contextid;_fragment.default.loadFragment("filter_envf","userprofile_form",contextid,{}).then(((form,js)=>(_templates.default.replaceNodeContents(element,form,js),new UserForm(element,contextid,userid),!0))).catch(_notification.default.exception)}))}}));

//# sourceMappingURL=userprofileform.min.js.map